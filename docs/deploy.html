<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.11: http://docutils.sourceforge.net/" />
<title>Deploy</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="deploy">
<h1 class="title">Deploy</h1>

<div class="section" id="infrastructure-overview">
<h1>Infrastructure Overview</h1>
<p>The Kano-Konnect project runs in production on an EC2 micro instance
in the EU-west-1 Availability zone. At present, the EC2 instance is named
&quot;kano-konnect-webserver&quot;.</p>
<p>The EC2 instance is part of a security group that exposes port 80 to
the open internet. The deployment uses nginx as a reverse proxy to
listen on port 80 and route requests from the open internet into a
uWSGI webserver. The nginx reverse proxy also directly
serves static files (images, CSS, etc.) out of a directory inside the
main project repo.</p>
<p>The uWSGI server runs the Django project code. We also run Celery
workers to process asynchronous tasks (with tasks and results passed
back and forth via a RabbitMQ server.)</p>
<p>&lt;IN THE FUTURE&gt;
Finally, an instance of JenkinsCI is running on the server. Jenkins
listens to a Github webhook, and when a new build is pushed to the
master repo, Jenkin runs the project test suite. If the test suite
passes, Jenkins deploys the new commit to the live production server.
&lt;/FUTURE&gt;</p>
</div>
<div class="section" id="project-code">
<h1>Project code</h1>
<p>All project/Python code lives in the directory:</p>
<pre class="literal-block">
/srv/kano_konnect
</pre>
<p>This directory contains three subdirectories:</p>
<p><em>releases</em> -- where the actual Python code lives. The live code is
current inside releases/kano_konnect. But more directories can be
created here to allow testing of new major releases while still
enabling rapid rollback.</p>
<p><em>shared</em> -- where any files that will be common to all releases should
live. Currently, that mainly means the project virtualenv which is
located at /srv/kano_konnect/shared/env</p>
<p><em>current</em> -- a symlink to the current, production code.</p>
<div class="section" id="static-files">
<h2>Static files</h2>
<p>Static files are served directly off the server from a directory via
nginx (see below.)</p>
<p>For ease of use, I track all the statics in Github and simply
push/pull them to the server. So the static directory is inside the
project repo (currently at
/srv/kano_konnect/current/kano_konnect/assets/).</p>
<p>This may not be best practice overall (git is not ideal for non-text
files like images) but in my experience it works fine up to at least
~100mb of static assets. And it makes the deployment process much
simpler. Just make sure to run:</p>
<pre class="literal-block">
python manage.py collectstatic
</pre>
<p>Before pushing commits to Github.</p>
</div>
<div class="section" id="requirements">
<h2>Requirements</h2>
<p>Updating the virtualenv is not yet automated. So if you add new
packages to the project, you must install them manually. Do do this,
run::</p>
<pre class="literal-block">
source /srv/kano_konnect/shared/env/bin/activate
pip install *your package or requirements file*
</pre>
</div>
</div>
<div class="section" id="nginx">
<h1>NGINX</h1>
<p>The nginx server is configured by two key config files.</p>
<p>The actual nginx server config is at::</p>
<pre class="literal-block">
/etc/nginx/nginx.conf
</pre>
<p>And the kano-konnect site specific configuration is at::</p>
<pre class="literal-block">
/etc/nginx/sites-available/kano_konnect.conf
</pre>
<p>(The site specific file is symlinked to
/etc/nginx/sites-enabled/kano_konnect.conf to make nginx actually
serve the site.)</p>
<div class="section" id="the-key-stanzas-in-config-files-are">
<h2>The key stanzas in config files are:</h2>
<div class="section" id="in-kano-konnect-conf">
<h3>In kano_konnect.conf:</h3>
<p><strong>location /static/ must point to the directory where static files live
on the server (currently the &quot;assets&quot; directory).</strong></p>
<p>Before pushing a commit to Github, you should collect static files
(which will put everything into the assets directory.) Then when you
pull on the server, the static assets will be pulled from Github and
put in the right place.</p>
<p><strong>location / must point to the socket or port that uUWGI is listening
on.</strong></p>
<p>Currently I have uWSGI running on port 9090. It may be somewhat
faster to run on a unix socket but for a low traffic site the
difference is likely to be immaterial. I'll leave it as it is for now
because it currently works fine.</p>
<p>This can easily be changed if you have a preferred way to run uWSGI.</p>
</div>
<div class="section" id="in-nginx-conf">
<h3>In nginx.conf:</h3>
<p>The project repo is owned by the &quot;nobody user&quot; so nginx must run as
&quot;nobody&quot;. This is accomplished by adding the line::</p>
<pre class="literal-block">
user nobody nogroup;
</pre>
<p>To nginx.conf</p>
</div>
</div>
</div>
<div class="section" id="uwsgi">
<h1>uWSGI</h1>
<p>The uWSGI process (and also Celery -- see below) is managed by
supervisor, a python process controller that gives a convenient way to
keep the server process alive by restarting it if it crashes for some
reason.</p>
<p>Supervisor also gives a way to start/restart the uWSGI process from
the commandline via the <em>supervisorctl</em> command, e.g.:</p>
<pre class="literal-block">
sudo supervisorctl restart kano_konnect-uwsgi
</pre>
<p>Supervisor needs to be told how to start the uWSGI and celery
processes, and those instructions live at::</p>
<pre class="literal-block">
/etc/supervisor.d/kano_konnect-uwsgi.conf
</pre>
<p>and:</p>
<pre class="literal-block">
/etc/supervisor.d/kano_konnect-celeryd.conf
</pre>
<p>The key line in these files is::</p>
<pre class="literal-block">
command=/srv/kano_konnect/shared/env/bin/uwsgi --http :9090 --wsgi-file kano_konnect/kano_konnect/wsgi.py
</pre>
<p>This line must specify exactly how the process would be started from
the commandline. If you wish to change uWSGI to use a Unix socket (or
an .ini file), you'll need to edit this line.</p>
<p>By default, supervisor routes all log output to the directory:</p>
<pre class="literal-block">
/var/log/supervisor/
</pre>
<p>And creates one log file for the stdout and stderr of each managed
process.</p>
<p>If you edit supervisor config files, you must &quot;reread&quot; them with the
command::</p>
<pre class="literal-block">
sudo supervisorctl reread
</pre>
<p>And then reload supervisor with::</p>
<pre class="literal-block">
sudo supervisorctl reload
</pre>
<p>You can also restart supervised processes with:</p>
<pre class="literal-block">
sudo supervisorctl restart [PROCESS_NAME]
</pre>
</div>
<div class="section" id="id1">
<h1>uWSGI</h1>
<p>The uWSGI configuration is currently very &quot;off the shelf&quot;. No .ini
file is being used. If you wish to supply a .ini file, write one and
edit the supervisor config file for uWSGi to include it via the
command line command.</p>
</div>
<div class="section" id="celery">
<h1>Celery</h1>
<p>Celery is also managed by supervisor. The integration into Django is
specified in the file:</p>
<pre class="literal-block">
/srv/kano_konnect/current/kano_konnect/kano_konnect/celery.py
</pre>
<p>Tasks should be specified inside of the file::</p>
<pre class="literal-block">
/srv/kano_konnect/current/kano_konnect/kano_konnect/tasks.py
</pre>
<p>On the server, Celery requires rabbitmq to be running. Rabbit should
start when the server starts and run automatically, but if it ever
crashes it can be restarted with::</p>
<pre class="literal-block">
sudo service rabbitmq-server restart
</pre>
</div>
<div class="section" id="postgres">
<h1>Postgres</h1>
<p>Postgres is running as a service on the webserver. The &quot;cluster&quot;
contains a database called &quot;kano_konnect&quot;. You can interact
via psql by doing:</p>
<pre class="literal-block">
sudo -u postgres psql
</pre>
</div>
<div class="section" id="updating-code">
<h1>Updating code:</h1>
<p>The CI integration is currently broken. So code must be updated
manually.</p>
<p>To update the repo, simply ssh into the server via something like:</p>
<pre class="literal-block">
ssh -i ~/.ec2/kano-konnect-key.pem ubuntu&#64;ec2-54-228-139-57.eu-west-1.compute.amazonaws.com
</pre>
<p>Then do:</p>
<pre class="literal-block">
cd /srv/kano_konnect/current
sudo -u nobody git pull
source /srv/kano_konnect/shared/env/bin/activate
cd kano_konnect/
# sync the database
sudo -u nobody python manage.py syncdb --settings=kano_konnect.settings.production
</pre>
</div>
</div>
</body>
</html>
